name: Render All Quarto Files (Fast)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-r-${{ hashFiles('**/DESCRIPTION') }}
          restore-keys: ${{ runner.os }}-r-

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Install R packages (cached)
        run: |
          Rscript -e 'needed <- c(
            "tidyverse", "ggplot2", "dplyr", "rmarkdown", "gganimate", "av"
          );
          new_pkgs <- setdiff(needed, rownames(installed.packages()));
          if(length(new_pkgs)) install.packages(new_pkgs)'

      - name: Render all Quarto files in parallel
        run: |
          echo "Rendering all .qmd files in parallel..."
          find . -name "*.qmd" | xargs -P 4 -I {} quarto render {}
