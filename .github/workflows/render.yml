name: Render All Quarto Files (Fast)
on:
  push:
    branches: [ main ]
  pull_request:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: /home/runner/work/_temp/Library
          key: ${{ runner.os }}-r-${{ hashFiles('**/DESCRIPTION') }}
          restore-keys: ${{ runner.os }}-r-

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Install R packages
        run: |
          Rscript -e 'needed <- c(
            "tidyverse", "ggplot2", "dplyr", "rmarkdown", "gganimate", "av"
          );
          new_pkgs <- setdiff(needed, rownames(installed.packages()));
          if(length(new_pkgs)) install.packages(new_pkgs)'

      - name: Find and render all Quarto files
        run: |
          echo "üîç Fichiers .qmd trouv√©s :"
          find . -type f -name "*.qmd" -not -path "./.git/*" | sort
          
          echo ""
          echo "‚è≥ Rendu en cours (parall√©lisation x4)..."
          find . -type f -name "*.qmd" -not -path "./.git/*" | xargs -P 4 -I {} sh -c '
            echo "üìÑ Rendu de : {}"
            quarto render "{}" || echo "‚ö†Ô∏è Erreur sur {}"
          '
          
          echo ""
          echo "‚úÖ Rendu termin√© !"
          echo ""
          echo "üìä Fichiers HTML g√©n√©r√©s :"
          find . -type f -name "*.html" -not -path "./.git/*" | sort

      - name: Commit and push rendered files
        if: always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          echo "üìç Fichiers modifi√©s :"
          git status --short
          
          git add -f "**/*.html" "**/*.md" || true
          
          if ! git diff --quiet --cached; then
            git commit -m "üìä Auto-render Quarto files [skip ci]"
            echo "‚úÖ Commit cr√©√©"
            git push origin HEAD:${{ github.ref }} 2>&1 || echo "‚ö†Ô∏è Push √©chou√©"
          else
            echo "‚ÑπÔ∏è Aucun changement"
          fi
