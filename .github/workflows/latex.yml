name: Build All LaTeX Documents
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      # ===== 1ï¸âƒ£ RÃ©cupÃ©ration du dÃ©pÃ´t =====
      - name: Checkout repository
        uses: actions/checkout@v4

      # ===== 2ï¸âƒ£ Cache LaTeX optimisÃ© =====
      - name: Cache LaTeX packages
        uses: actions/cache@v4
        with:
          path: |
            /usr/share/texlive
            ~/.texmf-var
          key: texlive-${{ runner.os }}-full-v2
          restore-keys: |
            texlive-${{ runner.os }}-full-
            texlive-${{ runner.os }}-

      # ===== 3ï¸âƒ£ Installation LaTeX complÃ¨te =====
      - name: Set up LaTeX environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            texlive-full \
            latexmk \
            cm-super \
            dvipng
          
          echo "âœ… LaTeX installÃ© avec succÃ¨s"
          pdflatex --version | head -1

      # ===== 4ï¸âƒ£ Configuration latexmk =====
      - name: Configure latexmk
        run: |
          mkdir -p ~/.config/latexmk
          cat > ~/.latexmkrc << 'EOF'
          $pdflatex = 'pdflatex -interaction=nonstopmode -halt-on-error %O %S';
          $max_repeat = 3;
          $clean_ext = "aux fls fdb_latexmk log out toc figlist makefile synctex.gz";
          $out_dir = '.';
          $silent = 0;
          EOF
          
          echo "âœ… Configuration latexmk crÃ©Ã©e"

      # ===== 5ï¸âƒ£ Compilation des fichiers LaTeX =====
      - name: Compile all LaTeX files
        run: |
          echo "ðŸ” DÃ©marrage de la compilation..."
          echo ""
          
          TOTAL_FILES=0
          COMPILED_COUNT=0
          FAILED_COUNT=0
          ERRORS_LOG="build_errors.log"
          
          # Initialiser le fichier d'erreurs
          : > "$ERRORS_LOG"
          
          # Patterns Ã  compiler (dans l'ordre)
          PATTERNS=("Cours.tex" "TD.tex" "CorrigÃ©.tex" "TP.tex" "SheetCheat.tex" "Poster.tex" "Diapo.tex")
          
          # Boucle sur chaque pattern
          for pattern in "${PATTERNS[@]}"; do
            echo "ðŸ“‹ Recherche des fichiers: $pattern"
            
            # Trouver tous les fichiers correspondants (exclure .git)
            files=$(find . -type f -name "$pattern" -not -path "./.git/*" | sort)
            
            if [ -z "$files" ]; then
              echo "   (aucun fichier trouvÃ©)"
              continue
            fi
            
            # Compiler chaque fichier dans son contexte
            while IFS= read -r file; do
              ((TOTAL_FILES++))
              
              dir=$(dirname "$file")
              name=$(basename "$file" .tex)
              full_path="$GITHUB_WORKSPACE/$dir"
              
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ðŸ“„ [$TOTAL_FILES] Compilation: $file"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              
              # Changer de rÃ©pertoire
              cd "$full_path" || exit 1
              
              # Nettoyer avant compilation
              latexmk -c "$name.tex" 2>/dev/null || true
              
              # Compiler avec timeout (8 min par fichier)
              if timeout 480 latexmk -pdf "$name.tex" > "$name.tmp.log" 2>&1; then
                
                # VÃ©rifier que le PDF existe
                if [ -f "$name.pdf" ]; then
                  ((COMPILED_COUNT++))
                  size=$(ls -lh "$name.pdf" | awk '{print $5}')
                  echo "âœ… SuccÃ¨s: $name.pdf gÃ©nÃ©rÃ© ($size)"
                  
                  # Garder le .log pour la rÃ©fÃ©rence
                  mv "$name.tmp.log" "$name.log"
                else
                  ((FAILED_COUNT++))
                  echo "âŒ Erreur: PDF non gÃ©nÃ©rÃ© (check $name.log)"
                  mv "$name.tmp.log" "$name.log"
                  echo "FAILED: $dir/$pattern - PDF non gÃ©nÃ©rÃ©" >> "$ERRORS_LOG"
                fi
              else
                ((FAILED_COUNT++))
                echo "âŒ Erreur: Compilation Ã©chouÃ©e ou timeout (8 min)"
                echo "FAILED: $dir/$pattern - Timeout ou erreur de compilation" >> "$ERRORS_LOG"
                if [ -f "$name.tmp.log" ]; then
                  mv "$name.tmp.log" "$name.log"
                fi
              fi
              
              # Revenir au workspace
              cd "$GITHUB_WORKSPACE" || exit 1
              
            done <<< "$files"
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š RÃ‰SUMÃ‰ DE COMPILATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Total fichiers trouvÃ©s: $TOTAL_FILES"
          echo "âœ… SuccÃ¨s: $COMPILED_COUNT"
          echo "âŒ Erreurs: $FAILED_COUNT"
          echo ""
          
          # Afficher les PDFs gÃ©nÃ©rÃ©s
          echo "ðŸ“‹ PDFs gÃ©nÃ©rÃ©s:"
          find . -type f \( -name "Cours.pdf" -o -name "TD.pdf" -o -name "CorrigÃ©.pdf" -o -name "TP.pdf" -o -name "SheetCheat.pdf" -o -name "Poster.pdf" -o -name "Diapo.pdf" \) -not -path "./.git/*" -exec ls -lh {} \; | awk '{print "   " $9 " (" $5 ")"}'
          
          echo ""
          
          # Afficher les erreurs s'il y en a
          if [ -s "$ERRORS_LOG" ]; then
            echo "âš ï¸  FICHIERS AVEC ERREURS:"
            cat "$ERRORS_LOG" | sed 's/^/   /'
            echo ""
          fi
          
          # Exporter les variables pour les Ã©tapes suivantes
          echo "TOTAL_FILES=$TOTAL_FILES" >> $GITHUB_ENV
          echo "COMPILED_COUNT=$COMPILED_COUNT" >> $GITHUB_ENV
          echo "FAILED_COUNT=$FAILED_COUNT" >> $GITHUB_ENV

      # ===== 6ï¸âƒ£ Archiver les logs d'erreur =====
      - name: Archive error logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: latex-logs
          path: |
            **/*.log
            build_errors.log
          retention-days: 7

      # ===== 7ï¸âƒ£ Commit et push des PDFs =====
      - name: Commit and push PDFs
        if: always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          echo "ðŸ“ VÃ©rification des PDFs avant commit..."
          find . -type f \( -name "Cours.pdf" -o -name "TD.pdf" -o -name "CorrigÃ©.pdf" -o -name "TP.pdf" -o -name "SheetCheat.pdf" -o -name "Poster.pdf" -o -name "Diapo.pdf" \) -not -path "./.git/*" | sort
          
          # Ajouter tous les PDFs gÃ©nÃ©rÃ©s
          git add "**/*.pdf" || true
          
          # VÃ©rifier les fichiers en attente
          echo ""
          echo "ðŸ“ Fichiers en attente de commit:"
          git status --short
          
          # Commit si changements
          if ! git diff --quiet --cached; then
            git commit -m "ðŸ“„ Auto-generate PDFs [${{ env.COMPILED_COUNT }}âœ… / ${{ env.TOTAL_FILES }}] [skip ci]"
            echo "âœ… Commit crÃ©Ã©"
            
            # Push avec retry
            for i in {1..3}; do
              if git push origin HEAD:${{ github.ref }}; then
                echo "âœ… Push rÃ©ussi"
                break
              else
                echo "âš ï¸  Tentative $i/3 Ã©chouÃ©e, nouvelle tentative..."
                sleep 5
              fi
            done
          else
            echo "â„¹ï¸  Aucun changement Ã  commiter"
          fi

      # ===== 8ï¸âƒ£ Notification rÃ©sumÃ©e =====
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š RÃ©sumÃ© de la compilation LaTeX" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| MÃ©trique | Valeur |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total fichiers | ${{ env.TOTAL_FILES }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… SuccÃ¨s | ${{ env.COMPILED_COUNT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Erreurs | ${{ env.FAILED_COUNT }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ env.FAILED_COUNT }}" -gt 0 ]; then
            echo "âš ï¸ **Des compilations ont Ã©chouÃ©. VÃ©rifiez les logs.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Toutes les compilations ont rÃ©ussi !**" >> $GITHUB_STEP_SUMMARY
          fi
