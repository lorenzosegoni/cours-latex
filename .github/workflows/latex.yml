name: Build All LaTeX Documents
on:
  push:
    branches: [ main ]
  pull_request:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1Ô∏è‚É£ R√©cup√©ration du d√©p√¥t
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Cache LaTeX
      - name: Cache LaTeX packages
        uses: actions/cache@v4
        with:
          path: |
            /usr/share/texlive
            /var/cache/apt/archives
          key: texlive-${{ runner.os }}-v2
          restore-keys: |
            texlive-${{ runner.os }}-

      # 3Ô∏è‚É£ Installation LaTeX optimis√©e
      - name: Set up LaTeX environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            texlive-base \
            texlive-latex-base \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-lang-french \
            texlive-pictures \
            texlive-science \
            latexmk \
            cm-super \
            dvipng

      # 4Ô∏è‚É£ Compilation locale dans chaque dossier
      - name: Compile all LaTeX files
        run: |
          # Configuration optimale de latexmk
          cat > ~/.latexmkrc << 'EOF'
          $pdflatex = 'pdflatex -interaction=nonstopmode -halt-on-error %O %S';
          $max_repeat = 3;
          $clean_ext = "aux fls fdb_latexmk log out toc figlist makefile";
          EOF
          
          echo "üîç Compilation en cours..."
          echo ""
          
          # Compiler chaque fichier dans son dossier
          for pattern in "Cours.tex" "TD.tex" "Corrig√©.tex" "TP.tex" "SheetCheat.tex" "Poster.tex" "Diapo.tex"; do
            find . -type f -name "$pattern" | while read file; do
              echo "üìÑ $file"
              dir=$(dirname "$file")
              name=$(basename "$file" .tex)
              
              cd "$dir"
              
              # Nettoyage avant compilation
              latexmk -c "$name.tex" 2>/dev/null || true
              
              # Compilation avec timeout de 5 min
              if timeout 300 latexmk -pdf "$name.tex"; then
                if [ -f "$name.pdf" ]; then
                  echo "   ‚úÖ $name.pdf cr√©√©"
                else
                  echo "   ‚ùå Erreur : PDF non g√©n√©r√©"
                fi
              else
                echo "   ‚ùå Erreur : Compilation √©chou√©e ou timeout"
              fi
              
              cd - > /dev/null
            done
          done
          
          echo ""
          echo "‚úÖ Compilation termin√©e !"
          echo ""
          echo "üìä R√©sum√© des PDFs g√©n√©r√©s :"
          find . -type f \( -name "Cours.pdf" -o -name "TD.pdf" -o -name "Corrig√©.pdf" -o -name "TP.pdf" -o -name "SheetCheat.pdf" -o -name "Poster.pdf" -o -name "Diapo.pdf" \) -exec ls -lh {} \;

      # 5Ô∏è‚É£ Commit et push des PDFs
      - name: Commit and push PDFs
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Ajouter tous les PDFs g√©n√©r√©s
          git add -A "*.pdf" || true
          
          # Commit si des changements
          git diff --quiet --cached || git commit -m "üìÑ Auto-generate PDFs from LaTeX sources"
          
          # Push
          git push origin HEAD:${{ github.ref }} || echo "Rien √† push"
