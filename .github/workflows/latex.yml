name: Build All LaTeX Documents
on:
  push:
    branches: [ main ]
  pull_request:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1Ô∏è‚É£ R√©cup√©ration du d√©p√¥t
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Cache LaTeX (lightweight)
      - name: Cache LaTeX packages
        uses: actions/cache@v4
        with:
          path: /usr/share/texlive
          key: texlive-${{ runner.os }}-v3
          restore-keys: |
            texlive-${{ runner.os }}-
          save-always: false

      # 3Ô∏è‚É£ Installation LaTeX optimis√©e
      - name: Set up LaTeX environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            texlive-base \
            texlive-latex-base \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-lang-french \
            texlive-pictures \
            texlive-science \
            latexmk \
            cm-super \
            dvipng

      # 4Ô∏è‚É£ Compilation locale dans chaque dossier
      - name: Compile all LaTeX files
        run: |
          # Configuration optimale de latexmk
          cat > ~/.latexmkrc << 'EOF'
          $pdflatex = 'pdflatex -interaction=nonstopmode -halt-on-error %O %S';
          $max_repeat = 3;
          $clean_ext = "aux fls fdb_latexmk log out toc figlist makefile";
          EOF
          
          echo "üîç Compilation en cours..."
          echo ""
          
          COMPILED_COUNT=0
          
          # Compiler chaque fichier dans son dossier
          for pattern in "Cours.tex" "TD.tex" "Corrig√©.tex" "TP.tex" "SheetCheat.tex" "Poster.tex" "Diapo.tex"; do
            find . -type f -name "$pattern" -not -path "./.git/*" | while read file; do
              echo "üìÑ $file"
              dir=$(dirname "$file")
              name=$(basename "$file" .tex)
              
              cd "$GITHUB_WORKSPACE/$dir"
              
              # Nettoyage avant compilation
              latexmk -c "$name.tex" 2>/dev/null || true
              
              # Compilation avec timeout de 5 min
              if timeout 300 latexmk -pdf "$name.tex" 2>&1 | grep -E "Output written|Latexmk:"; then
                if [ -f "$name.pdf" ]; then
                  echo "   ‚úÖ $name.pdf cr√©√© avec succ√®s"
                  ls -lh "$name.pdf"
                else
                  echo "   ‚ùå Erreur : PDF non g√©n√©r√©"
                fi
              else
                echo "   ‚ùå Erreur : Compilation √©chou√©e ou timeout"
              fi
            done
          done
          
          echo ""
          echo "‚úÖ Compilation termin√©e !"
          echo ""
          echo "üìä R√©sum√© des PDFs g√©n√©r√©s :"
          find . -type f \( -name "Cours.pdf" -o -name "TD.pdf" -o -name "Corrig√©.pdf" -o -name "TP.pdf" -o -name "SheetCheat.pdf" -o -name "Poster.pdf" -o -name "Diapo.pdf" \) -not -path "./.git/*"

      # 5Ô∏è‚É£ Commit et push des PDFs
      - name: Commit and push PDFs
        if: always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # V√©rifier quels PDFs ont √©t√© cr√©√©s
          echo "üìç PDFs trouv√©s avant commit :"
          find . -type f \( -name "Cours.pdf" -o -name "TD.pdf" -o -name "Corrig√©.pdf" -o -name "TP.pdf" -o -name "SheetCheat.pdf" -o -name "Poster.pdf" -o -name "Diapo.pdf" \) -not -path "./.git/*" | sort
          
          # Ajouter tous les PDFs g√©n√©r√©s
          git add -f "**/*.pdf" || true
          
          # V√©rifier les fichiers en attente
          echo ""
          echo "üìç Fichiers en attente de commit :"
          git status --short
          
          # Commit si des changements
          if ! git diff --quiet --cached; then
            git commit -m "üìÑ Auto-generate PDFs from LaTeX sources [skip ci]"
            echo "‚úÖ Commit cr√©√©"
            
            # Push
            git push origin HEAD:${{ github.ref }} 2>&1 || echo "‚ö†Ô∏è Push √©chou√©"
          else
            echo "‚ÑπÔ∏è Aucun changement √† commiter"
          fi
