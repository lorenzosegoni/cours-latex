name: Build All LaTeX Documents
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    permissions:         # <--- AJOUTEZ CECI
      contents: write    # <--- ET CECI
    
    steps:
      # ===== 1Ô∏è‚É£ R√©cup√©ration du d√©p√¥t =====
      - name: Checkout repository
        uses: actions/checkout@v4

      # ===== 2Ô∏è‚É£ Cache LaTeX optimis√© =====
      - name: Restore LaTeX cache
        uses: actions/cache/restore@v4
        with:
          path: |
            /usr/share/texlive
            ~/.texmf-var
          key: texlive-${{ runner.os }}-full-v2
          restore-keys: |
            texlive-${{ runner.os }}-full-
            texlive-${{ runner.os }}-

      # ===== 3Ô∏è‚É£ Installation LaTeX compl√®te =====
      - name: Set up LaTeX environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            texlive-full \
            latexmk \
            cm-super \
            dvipng
          
          echo "‚úÖ LaTeX install√© avec succ√®s"
          pdflatex --version | head -1

      # ===== 4Ô∏è‚É£ Configuration latexmk =====
      - name: Configure latexmk
        run: |
          mkdir -p ~/.config/latexmk
          cat > ~/.latexmkrc << 'EOF'
          $pdflatex = 'pdflatex -interaction=nonstopmode -halt-on-error %O %S';
          $max_repeat = 3;
          $clean_ext = "aux fls fdb_latexmk log out toc figlist makefile synctex.gz";
          $out_dir = '.';
          $silent = 0;
          EOF
          
          echo "‚úÖ Configuration latexmk cr√©√©e"

      # ===== 5Ô∏è‚É£ Compilation des fichiers LaTeX =====
      - name: Compile all LaTeX files
        # Pas besoin de 'shell: bash' pour cette version
        run: |
          echo "üîç D√©marrage de la compilation..."
          echo ""

          echo "üìÇ V√©rification initiale : fichiers d√©tect√©s dans le d√©p√¥t"
          echo "--------------------------------------------------------"
          find . -type f -name "*.tex" -not -path "./.git/*" | sort || echo "(aucun fichier trouv√©)"
          echo "--------------------------------------------------------"
          echo ""

          TOTAL_FILES=0
          COMPILED_COUNT=0
          FAILED_COUNT=0
          ERRORS_LOG="build_errors.log"
          
          # Initialiser le fichier d'erreurs
          : > "$ERRORS_LOG"
          
          # Patterns √† compiler (liste pour shell POSIX sh, s√©par√©e par des espaces)
          PATTERNS="Cours.tex TD.tex Corrig√©.tex TP.tex SheetCheat.tex Poster.tex Diapo.tex"
          
          # Boucle sur chaque pattern (syntaxe sh)
          for pattern in $PATTERNS; do
            echo "üìã Recherche des fichiers: $pattern"
            
            # Trouver tous les fichiers correspondants
            files=$(find . -type f -name "$pattern" -not -path "./.git/*" 2>/dev/null || true)
            
            # Si aucun fichier trouv√© ‚Üí on passe au suivant
            if [ -z "$files" ]; then
              echo "   (aucun fichier trouv√©)"
              continue
            fi
            
            # Compiler chaque fichier trouv√©
            # Utilisation de "echo ... | while read" (compatible sh)
            echo "$files" | while IFS= read -r file; do
              # S√©curit√© pour ignorer les lignes vides
              if [ -z "$file" ]; then continue; fi
            
              # Incr√©mentation compatible sh
              TOTAL_FILES=$((TOTAL_FILES + 1))
              
              dir=$(dirname "$file")
              name=$(basename "$file" .tex)
              
              echo ""
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "üìÑ [$TOTAL_FILES] Compilation: $file"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              
              # Aller dans le r√©pertoire du fichier
              cd "$dir" || { echo "Erreur: impossible d‚Äôentrer dans $dir"; continue; }
              
              # Nettoyer avant
              latexmk -c "$name.tex" 2>/dev/null || true
              
              if timeout 480 latexmk -pdf "$name.tex" > "$name.tmp.log" 2>&1; then
                if [ -f "$name.pdf" ]; then
                  COMPILED_COUNT=$((COMPILED_COUNT + 1))
                  size=$(ls -lh "$name.pdf" | awk '{print $5}')
                  echo "‚úÖ Succ√®s: $name.pdf g√©n√©r√© ($size)"
                  mv "$name.tmp.log" "$name.log"
                else
                  FAILED_COUNT=$((FAILED_COUNT + 1))
                  echo "‚ùå Erreur: PDF non g√©n√©r√© (check $name.log)"
                  mv "$name.tmp.log" "$name.log"
                  echo "FAILED: $file - PDF non g√©n√©r√©" >> "$GITHUB_WORKSPACE/$ERRORS_LOG"
                fi
              else
                FAILED_COUNT=$((FAILED_COUNT + 1))
                echo "‚ùå Erreur: Compilation √©chou√©e ou timeout (8 min)"
                echo "FAILED: $file - Timeout ou erreur de compilation" >> "$GITHUB_WORKSPACE/$ERRORS_LOG"
                if [ -f "$name.tmp.log" ]; then
                  mv "$name.tmp.log" "$name.log"
                fi
              fi
              
              # Retourner au r√©pertoire de base
              cd "$GITHUB_WORKSPACE" || exit 1
            
            done # Fin de la boucle while
          done # Fin de la boucle for
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä R√âSUM√â DE COMPILATION"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Total fichiers trouv√©s: $TOTAL_FILES"
          echo "‚úÖ Succ√®s: $COMPILED_COUNT"
          echo "‚ùå Erreurs: $FAILED_COUNT"
          echo ""
          
          echo "üìã PDFs g√©n√©r√©s:"
          
          # Recr√©er la logique de find pour sh
          find_args=""
          for p in $PATTERNS; do
            # Remplacer .tex par .pdf
            pdf_name=$(echo "$p" | sed 's/\.tex$/.pdf/')
            if [ -z "$find_args" ]; then
              find_args="-name $pdf_name"
            else
              find_args="$find_args -o -name $pdf_name"
            fi
          done
          
          # Ex√©cuter find avec les arguments construits
          # "eval" est n√©cessaire pour que les arguments -o soient interpr√©t√©s correctement
          eval "find . -type f \( $find_args \) -not -path \"./.git/*\"" | while read -r f; do
             if [ -n "$f" ]; then # S'assurer que la ligne n'est pas vide
               size=$(ls -lh "$f" | awk '{print $5}')
               echo "   $f ($size)"
             fi
          done
          
          echo ""
          
          if [ -s "$ERRORS_LOG" ]; then
            echo "‚ö†Ô∏è  FICHIERS AVEC ERREURS:"
            cat "$ERRORS_LOG" | sed 's/^/   /'
            echo ""
          fi
          
          echo "TOTAL_FILES=$TOTAL_FILES" >> $GITHUB_ENV
          echo "COMPILED_COUNT=$COMPILED_COUNT" >> $GITHUB_ENV
          echo "FAILED_COUNT=$FAILED_COUNT" >> $GITHUB_ENV

          # Si des erreurs ont eu lieu, faire √©chouer le job
          if [ "$FAILED_COUNT" -gt 0 ]; then
             echo "::error::Il y a eu $FAILED_COUNT erreurs de compilation."
             exit 1
          fi
          
      # ===== 5Ô∏è‚É£ bis Sauvegarder le cache LaTeX =====
      - name: Save LaTeX cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: |
            /usr/share/texlive
            ~/.texmf-var
          key: texlive-${{ runner.os }}-full-v2-${{ github.run_id }}
      - name: Archive error logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: latex-logs
          path: |
            **/*.log
            build_errors.log
          retention-days: 7

      # ===== 7Ô∏è‚É£ Commit et push des PDFs =====
      - name: Commit and push PDFs
        if: always()
        shell: bash      # <--- AJOUTEZ CECI
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          echo "üìç V√©rification des PDFs avant commit..."
          find . -type f \( -name "Cours.pdf" -o -name "TD.pdf" -o -name "Corrig√©.pdf" -o -name "TP.pdf" -o -name "SheetCheat.pdf" -o -name "Poster.pdf" -o -name "Diapo.pdf" \) -not -path "./.git/*" | sort
          
          # Ajouter tous les PDFs g√©n√©r√©s
          git add "**/*.pdf" || true
          
          # V√©rifier les fichiers en attente
          echo ""
          echo "üìç Fichiers en attente de commit:"
          git status --short
          
          # Commit si changements
          if ! git diff --quiet --cached; then
            git commit -m "üìÑ Auto-generate PDFs [${{ env.COMPILED_COUNT }}‚úÖ / ${{ env.TOTAL_FILES }}] [skip ci]"
            echo "‚úÖ Commit cr√©√©"
            
            # Push avec retry
            for i in {1..3}; do
              if git push origin HEAD:${{ github.ref }}; then
                echo "‚úÖ Push r√©ussi"
                break
              else
                echo "‚ö†Ô∏è  Tentative $i/3 √©chou√©e, nouvelle tentative..."
                sleep 5
              fi
            done
          else
            echo "‚ÑπÔ∏è  Aucun changement √† commiter"
          fi

      # ===== 8Ô∏è‚É£ Notification r√©sum√©e =====
      - name: Summary
        if: always()
        run: |
          echo "## üìä R√©sum√© de la compilation LaTeX" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| M√©trique | Valeur |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total fichiers | ${{ env.TOTAL_FILES }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚úÖ Succ√®s | ${{ env.COMPILED_COUNT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ùå Erreurs | ${{ env.FAILED_COUNT }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ env.FAILED_COUNT }}" -gt 0 ]; then
            echo "‚ö†Ô∏è **Des compilations ont √©chou√©. V√©rifiez les logs.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **Toutes les compilations ont r√©ussi !**" >> $GITHUB_STEP_SUMMARY
          fi
